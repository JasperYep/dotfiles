#!/bin/bash

VM_NAME="win10-office"
VM_IP="192.168.122.67"
USER="jasper"
PASS="123456"
VIRSH_CMD="virsh --connect qemu:///system"

# 1. å¦‚æžœè™šæ‹Ÿæœºæœªè¿è¡Œåˆ™å¯åŠ¨
if ! $VIRSH_CMD list --name | grep -q "^${VM_NAME}$"; then
  echo "ðŸš€ Starting VM: $VM_NAME..."
  $VIRSH_CMD start "$VM_NAME"
fi

# 2. ç­‰å¾…ç½‘ç»œå’Œ RDP æœåŠ¡å°±ç»ª
echo -n "â³ Waiting for VM ($VM_IP) to be ready..."
for i in {1..60}; do
  # # ä¼˜å…ˆä½¿ç”¨ nc (netcat) æ£€æµ‹ RDP ç«¯å£ (3389) æ˜¯å¦å¼€æ”¾
  # if nc -z -w 1 $VM_IP 3389 &>/dev/null; then
    # ä¼˜å…ˆä½¿ç”¨ nc (netcat) æ£€æµ‹ RDP ç«¯å£ (3389) æ˜¯å¦å¼€æ”¾
    if ping -c 1 -W 1 $VM_IP &>/dev/null; then
    echo " âœ… Ready!"
    break
  fi

  echo -n "."
  sleep 2

  if [ $i -eq 60 ]; then
    echo " âŒ Timeout: VM RDP service is not reachable."
    exit 1
  fi
done

# 3. å¯åŠ¨è¿œç¨‹æ¡Œé¢
xfreerdp3 /v:$VM_IP /u:$USER /p:$PASS \
/network:lan /gfx:avc420:on /gdi:hw /bpp:32 \
/audio-mode:1 /sound:sys:pulse /microphone:sys:pulse \
/size:95% /scale:180 /dynamic-resolution \
/frame-ack:0 /compression-level:0 \
-wallpaper -themes -fonts -menu-anims -decorations \
+clipboard +window-drag +auto-request-control \
> /dev/null 2>&1 &
