#!/bin/bash
set -euo pipefail

echo "üöÄ Starting deployment script..."

# ------------------- ÈÖçÁΩÆ -------------------
DOTFILES_REPO="https://github.com/JasperYep/dotfiles.git"
BARE_REPO="$HOME/.cfg"
BACKUP_DIR="$HOME/.config-backup-$(date +%Y%m%d-%H%M%S)"

# ------------------- Âü∫Á°ÄÂáΩÊï∞ -------------------
log_error() {
    echo "‚ùå $*" >&2
}

require_cmd() {
    if ! command -v "$1" &>/dev/null; then
        log_error "Required command '$1' not found. Please install it first."
        exit 1
    fi
}

# ------------------- Ê£ÄÊü•ÂëΩ‰ª§ -------------------
require_cmd git
require_cmd curl
require_cmd sudo
require_cmd pacman

echo "‚úÖ basic commands found"

# ------------------- ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑ -------------------
echo "Installing base packages..."
# Âè™ÂÆâË£ÖÈúÄË¶ÅÁöÑÔºå‰∏çÂÅöÂÖ®Â±ÄÂçáÁ∫ß
sudo pacman -Sy --needed --noconfirm \
    git yazi zsh vim neovim kitty i3 fzf fd ripgrep rofi \
    adobe-source-han-sans-cn-fonts adobe-source-han-serif-cn-fonts ttf-jetbrains-mono-nerd \
    firefox lightdm picom feh \
    fcitx5-im fcitx5-rime rime-double-pinyin

# git clone https://github.com/LazyVim/starter ~/.config/nvim
# rm -rf ~/.config/nvim/.git
# ------------------- ÂÖãÈöÜË£∏‰ªìÂ∫ì -------------------
if [ -e "$BARE_REPO" ]; then
    echo "‚ö†Ô∏è  Existing repo detected: $BARE_REPO"
    echo "    Backing it up to ${BARE_REPO}.bak-$(date +%s)"
    mv "$BARE_REPO" "${BARE_REPO}.bak-$(date +%s)"
fi

echo "Cloning bare repository..."
git clone --bare "$DOTFILES_REPO" "$BARE_REPO"

# ------------------- ÂÆö‰πâ git wrapper -------------------
dog() {
    /usr/bin/git --git-dir="$BARE_REPO" --work-tree="$HOME" "$@"
}
export -f dog

dog config --local status.showUntrackedFiles no
echo "Bare repository configured."

# ------------------- Â§á‰ªΩÂÜ≤Á™ÅÊñá‰ª∂ -------------------
dog checkout -f
echo "Dotfiles checked out successfully."

# ------------------- ËÆæÁΩÆ exclude -------------------
echo ".zim/modules/" >>"$BARE_REPO/info/exclude"
echo ".cache/" >>"$BARE_REPO/info/exclude"
echo "Git exclude setup done."

# ------------------- ÂÆâË£Ö Neovim (LazyVim) Êèí‰ª∂ -------------------

# if command -v nvim &>/dev/null && [ -d "$HOME/.config/nvim" ]; then
#     echo "Detected Neovim config. Assuming LazyVim setup."
#     echo "Triggering Lazy.nvim sync..."
#     nvim --headless "+Lazy! sync" +qa || true
# else
#     echo "‚ö†Ô∏è  Neovim not installed or config not found at ~/.config/nvim"
# fi

# ------------------- ÂÆâË£Ö Zim Framework -------------------
if [ ! -d "$HOME/.zim" ]; then
    echo "Installing Zim framework..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh)" "" --skip-yes
fi

chsh -s /usr/bin/zsh
exec zsh

zimfw install

# ------------------- ÊèêÁ§∫ -------------------

echo "Bootstrap complete!"
echo "- Conflicting files backed up in $BACKUP_DIR"
echo "- Dotfiles restored in $HOME"
echo "- Use 'dog status', 'dog add', 'dog commit', 'dog push' to manage dotfiles"
echo "- Zsh/Zim and Vim plugins installed"
echo "üéâ Deployment complete!"
